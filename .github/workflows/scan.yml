name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      
      - name: Download malware samples for testing
        if: hashFiles('package.json') && contains(github.event.head_commit.message, 'infected')
        env:
          UC_API_KEY: ${{ secrets.UC_API_KEY }}
        run: |
          # Create infected package directory
          mkdir -p node_modules/lodash_infected
          
          # Create package.json for the fake package
          echo '{"name":"lodash_infected","version":"4.17.21-infected","description":"Simulated compromised package for demo"}' > node_modules/lodash_infected/package.json
          
          # Debug: Check API key length (don't print the actual key!)
          echo "UC_API_KEY length: ${#UC_API_KEY}"
          
          # Download bun_environment.js (Shai Hulud obfuscated JS)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o bun_env.zip "https://api.unknowncyber.com/v2/files/cbb9bc5a8496243e02f3cc080efbe3e4a1430ba0671f2e43a202bf45b05479cd/download/?key=$UC_API_KEY")
          echo "Download bun_environment.js: HTTP $HTTP_CODE, size $(stat -c%s bun_env.zip 2>/dev/null || echo 0) bytes"
          
          # Check if it's a valid zip
          if file bun_env.zip | grep -q "Zip archive"; then
            unzip -P infected -o bun_env.zip -d node_modules/lodash_infected/
            mv node_modules/lodash_infected/cbb9bc5a8496243e02f3cc080efbe3e4a1430ba0671f2e43a202bf45b05479cd node_modules/lodash_infected/bun_environment.js 2>/dev/null || true
          else
            echo "ERROR: bun_env.zip is not a valid zip file!"
            echo "First 200 bytes of response:"
            head -c 200 bun_env.zip
            echo ""
          fi
          rm -f bun_env.zip
          
          # Download neotyxa.exe (actual malware binary)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o neotyxa.zip "https://api.unknowncyber.com/v2/files/7f20b9e8235746e29e853a4793f64b2a02cf6a4eeca56fd3bd1e110bb4a84b0e/download/?key=$UC_API_KEY")
          echo "Download neotyxa.exe: HTTP $HTTP_CODE, size $(stat -c%s neotyxa.zip 2>/dev/null || echo 0) bytes"
          
          if file neotyxa.zip | grep -q "Zip archive"; then
            unzip -P infected -o neotyxa.zip -d node_modules/lodash_infected/
            mv node_modules/lodash_infected/7f20b9e8235746e29e853a4793f64b2a02cf6a4eeca56fd3bd1e110bb4a84b0e node_modules/lodash_infected/neotyxa.exe 2>/dev/null || true
          else
            echo "ERROR: neotyxa.zip is not a valid zip file!"
            echo "First 200 bytes of response:"
            head -c 200 neotyxa.zip
            echo ""
          fi
          rm -f neotyxa.zip
          
          # Verify downloads
          echo "=== lodash_infected contents ==="
          ls -la node_modules/lodash_infected/ || echo "Directory not found"
      
      - name: Scan npm packages
        uses: Unknown-Cyber-Inc/npm-package-scanner@main
        id: scan
        with:
          upload: 'true'
          deep-scan: 'true'
          include-all-files: 'true'
          yara-scan: 'true'
          yara-include: '*.js,*.exe'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Scan Summary
        if: always()
        run: |
          echo "## ðŸ” NPM Package Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Packages Scanned" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Packages with binaries | ${{ steps.scan.outputs.total-packages }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary files found | ${{ steps.scan.outputs.total-binaries }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â˜ï¸ Upload Results" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Uploaded | ${{ steps.scan.outputs.upload-successful }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped (existing) | ${{ steps.scan.outputs.upload-skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.scan.outputs.upload-failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse detailed findings from results
          if [ -f "binary-scan-results.json" ]; then
            echo "### ðŸ›¡ï¸ Security Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract findings using Node.js
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('binary-scan-results.json', 'utf8'));
              const reps = results.uploadResults?.reputations || [];
              
              const high = reps.filter(r => r.reputation?.overallThreatLevel === 'high');
              const medium = reps.filter(r => r.reputation?.overallThreatLevel === 'medium');
              const caution = reps.filter(r => r.reputation?.overallThreatLevel === 'caution');
              
              let output = '';
              
              if (high.length > 0) {
                output += '#### ðŸ”´ High Severity\n';
                output += '| File | Issue |\n|------|-------|\n';
                high.forEach(r => {
                  const issues = [];
                  if (r.reputation?.av?.threatLevel === 'high') issues.push('AV: ' + r.reputation.av.detected + '/' + r.reputation.av.total);
                  if (r.reputation?.similarity?.threatLevel === 'high') issues.push('Similarity: ' + r.reputation.similarity.score);
                  output += '| ' + r.file + ' | ' + issues.join(', ') + ' |\n';
                });
                output += '\n';
              }
              
              if (medium.length > 0) {
                output += '#### ðŸŸ  Medium Severity\n';
                output += '| File | Issue |\n|------|-------|\n';
                medium.forEach(r => {
                  const issues = [];
                  if (r.reputation?.av?.threatLevel === 'medium') issues.push('AV: ' + r.reputation.av.detected + '/' + r.reputation.av.total);
                  if (r.reputation?.similarity?.threatLevel === 'medium') issues.push('Similarity: ' + r.reputation.similarity.score);
                  output += '| ' + r.file + ' | ' + issues.join(', ') + ' |\n';
                });
                output += '\n';
              }
              
              if (caution.length > 0) {
                output += '#### ðŸŸ¡ Caution\n';
                output += '| File | Issue |\n|------|-------|\n';
                caution.forEach(r => {
                  const issues = [];
                  if (r.reputation?.signature?.threatLevel === 'caution') issues.push('Unsigned binary');
                  if (r.reputation?.av?.threatLevel === 'caution') issues.push('AV: ' + r.reputation.av.detected + '/' + r.reputation.av.total);
                  output += '| ' + r.file + ' | ' + issues.join(', ') + ' |\n';
                });
                output += '\n';
              }
              
              if (high.length === 0 && medium.length === 0 && caution.length === 0) {
                output += 'âœ… No security issues detected\n';
              }
              
              console.log(output);
            " >> $GITHUB_STEP_SUMMARY
          fi
          
          # YARA findings
          if [ -f "yara-results.json" ]; then
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('yara-results.json', 'utf8'));
              
              if (results.results && results.results.length > 0) {
                let output = '### ðŸ”Ž YARA Matches\n';
                output += '| File | Rule | Severity |\n|------|------|----------|\n';
                results.results.forEach(r => {
                  r.matches.forEach(m => {
                    const sev = m.meta?.severity || 'unknown';
                    const icon = sev === 'critical' || sev === 'high' ? 'ðŸ”´' : sev === 'medium' ? 'ðŸŸ ' : 'ðŸŸ¡';
                    output += '| ' + r.file.split('/').slice(-2).join('/') + ' | ' + m.rule + ' | ' + icon + ' ' + sev + ' |\n';
                  });
                });
                console.log(output);
              }
            " >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          fi

      - name: Fail on threats
        if: (steps.scan.outputs.threats-found != '0' && steps.scan.outputs.threats-found != '') || (steps.scan.outputs.yara-high-severity != '0' && steps.scan.outputs.yara-high-severity != '')
        run: |
          echo "::error::Security issues detected! Threats: ${{ steps.scan.outputs.threats-found }}, YARA high severity: ${{ steps.scan.outputs.yara-high-severity }}"
          exit 1
